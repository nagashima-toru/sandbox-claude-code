#!/bin/sh

################################################################################
# Pre-push Hook
#
# This hook runs quick smoke tests before pushing to ensure basic checks pass.
# It's designed to be fast (<30 seconds) to avoid interrupting your workflow.
#
# What it does:
# - Detects which parts of the codebase changed (backend/frontend)
# - Runs quick compile and test for backend changes
# - Runs lint and type-check for frontend changes
#
# To skip this hook (emergency pushes):
#   git push --no-verify
#
# For comprehensive CI checks, run:
#   ./scripts/ci-check-local.sh
################################################################################

# Source husky.sh if it exists (optional for backward compatibility)
if [ -f "$(dirname "$0")/_/husky.sh" ]; then
  . "$(dirname "$0")/_/husky.sh"
fi

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color
BOLD='\033[1m'

echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}Pre-push checks running...${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Detect changed files
BACKEND_CHANGED=false
FRONTEND_CHANGED=false

# Check uncommitted changes
if git diff --name-only HEAD | grep -q "^backend/"; then
  BACKEND_CHANGED=true
fi

if git diff --name-only HEAD | grep -q "^frontend/"; then
  FRONTEND_CHANGED=true
fi

# Check committed but not pushed changes
if git diff --name-only @{u} 2>/dev/null | grep -q "^backend/"; then
  BACKEND_CHANGED=true
fi

if git diff --name-only @{u} 2>/dev/null | grep -q "^frontend/"; then
  FRONTEND_CHANGED=true
fi

# If no upstream branch, check staged changes
if ! git rev-parse @{u} >/dev/null 2>&1; then
  if git diff --cached --name-only | grep -q "^backend/"; then
    BACKEND_CHANGED=true
  fi

  if git diff --cached --name-only | grep -q "^frontend/"; then
    FRONTEND_CHANGED=true
  fi
fi

CHECKS_FAILED=false

# Backend smoke tests
if [ "$BACKEND_CHANGED" = true ]; then
  echo -e "${BLUE}▶ Backend changes detected${NC}"
  echo -e "${BLUE}  Running: ./mvnw compile test${NC}"
  echo ""

  cd backend
  if ./mvnw compile test > /tmp/pre-push-backend.log 2>&1; then
    echo -e "${GREEN}  ✅ Backend compile and tests passed${NC}"
  else
    echo -e "${RED}  ❌ Backend compile or tests failed${NC}"
    echo ""
    echo "Last 20 lines of output:"
    tail -20 /tmp/pre-push-backend.log
    echo ""
    CHECKS_FAILED=true
  fi
  cd ..
  echo ""
fi

# Frontend smoke tests
if [ "$FRONTEND_CHANGED" = true ]; then
  echo -e "${BLUE}▶ Frontend changes detected${NC}"
  echo -e "${BLUE}  Running: pnpm lint && pnpm type-check${NC}"
  echo ""

  cd frontend

  # Run lint
  if pnpm lint > /tmp/pre-push-lint.log 2>&1; then
    echo -e "${GREEN}  ✅ ESLint passed${NC}"
  else
    echo -e "${RED}  ❌ ESLint failed${NC}"
    echo ""
    cat /tmp/pre-push-lint.log
    echo ""
    CHECKS_FAILED=true
  fi

  # Run type-check
  if pnpm type-check > /tmp/pre-push-type-check.log 2>&1; then
    echo -e "${GREEN}  ✅ Type-check passed${NC}"
  else
    echo -e "${RED}  ❌ Type-check failed${NC}"
    echo ""
    cat /tmp/pre-push-type-check.log
    echo ""
    CHECKS_FAILED=true
  fi

  cd ..
  echo ""
fi

# Summary
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

if [ "$CHECKS_FAILED" = true ]; then
  echo ""
  echo -e "${RED}❌ Pre-push checks failed!${NC}"
  echo ""
  echo -e "${YELLOW}Please fix the issues above before pushing.${NC}"
  echo ""
  echo "To skip this hook (not recommended):"
  echo "  git push --no-verify"
  echo ""
  exit 1
fi

if [ "$BACKEND_CHANGED" = false ] && [ "$FRONTEND_CHANGED" = false ]; then
  echo -e "${YELLOW}No backend or frontend changes detected.${NC}"
  echo -e "${GREEN}Skipping pre-push checks.${NC}"
else
  echo -e "${GREEN}✅ Pre-push checks passed!${NC}"
fi

echo ""
echo -e "${YELLOW}RECOMMENDED: Run full CI checks before pushing:${NC}"
echo "  ./scripts/ci-check-local.sh"
echo ""
echo "To skip pre-push hook:"
echo "  git push --no-verify"
echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

exit 0
