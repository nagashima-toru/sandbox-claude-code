#!/bin/sh

set -e

REPO_ROOT=$(git rev-parse --show-toplevel)

# Frontend: Run lint-staged for staged files
echo "Running frontend checks..."
cd "$REPO_ROOT/frontend"

# Check if there are any staged frontend files
STAGED_FRONTEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^frontend/' || true)

if [ -n "$STAGED_FRONTEND_FILES" ]; then
  pnpm exec lint-staged || exit 1
else
  echo "No frontend files changed, skipping frontend checks"
fi

# Backend: Run compile for staged Java files
echo "Running backend checks..."
cd "$REPO_ROOT/backend"

# Get list of staged Java files
STAGED_JAVA_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^backend/.*\.java$' || true)

if [ -n "$STAGED_JAVA_FILES" ]; then
  echo "Java files changed, running Maven compile..."
  ./mvnw compile || exit 1
else
  echo "No Java files changed, skipping backend checks"
fi

cd "$REPO_ROOT"

echo "All pre-commit checks passed!"