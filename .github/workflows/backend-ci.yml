name: Backend CI

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up JDK 25
        uses: actions/setup-java@7a6d8a8234af8eb26422e24e3006232cccaa061b # v4.6.0
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build and test
        working-directory: ./backend
        run: ./mvnw clean verify -DskipDockerCompose=true
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
          SPRING_DATASOURCE_USERNAME: testuser
          SPRING_DATASOURCE_PASSWORD: testpass

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4.6.0
        with:
          name: test-results
          path: |
            backend/target/surefire-reports/**/*.xml
            backend/target/failsafe-reports/**/*.xml

      - name: Upload JaCoCo coverage report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4.6.0
        with:
          name: jacoco-report
          path: backend/target/site/jacoco/

      - name: Upload SpotBugs report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4.6.0
        with:
          name: spotbugs-report
          path: backend/target/spotbugsXml.xml

      - name: Upload Checkstyle report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4.6.0
        with:
          name: checkstyle-report
          path: backend/target/checkstyle-result.xml

      - name: Generate test summary
        if: always()
        uses: test-summary/action@v2
        with:
          paths: |
            backend/target/surefire-reports/**/*.xml
            backend/target/failsafe-reports/**/*.xml

      - name: Comment test coverage on PR
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.7.2
        with:
          paths: backend/target/site/jacoco/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 80
          min-coverage-changed-files: 80
          title: 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸'
          update-comment: true

  dependency-check:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up JDK 25
        uses: actions/setup-java@7a6d8a8234af8eb26422e24e3006232cccaa061b # v4.6.0
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Cache OWASP Dependency-Check data
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.m2/repository/org/owasp/dependency-check-data
          key: ${{ runner.os }}-dependency-check-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-dependency-check-

      - name: Run OWASP Dependency-Check
        working-directory: ./backend
        run: ./mvnw org.owasp:dependency-check-maven:check

      - name: Upload Dependency-Check report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4.6.0
        with:
          name: dependency-check-report
          path: |
            backend/target/dependency-check-report.html
            backend/target/dependency-check-report.xml
            backend/target/dependency-check-report.json

      - name: Generate security summary
        if: always()
        run: |
          echo "### ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f backend/target/dependency-check-report.json ]; then
            vulnerabilities=$(jq '[.dependencies[].vulnerabilities // []] | add | length' backend/target/dependency-check-report.json)
            if [ "$vulnerabilities" -gt 0 ]; then
              echo "âš ï¸ **$vulnerabilities å€‹ã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "è©³ç´°ã¯ [Dependency-Check ãƒ¬ãƒãƒ¼ãƒˆ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **è„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi

  contract-tests:
    name: Contract Tests
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run contract tests
        working-directory: ./backend
        run: |
          # ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
          # TODO: Spring Cloud Contract ã®è¨­å®šãŒå®Œäº†ã—ãŸã‚‰æœ‰åŠ¹åŒ–
          echo "Contract tests will be enabled after Spring Cloud Contract configuration"

      - name: Generate contract test summary
        if: always()
        run: |
          echo "### ðŸ¤ ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ†ã‚¹ãƒˆçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ†ã‚¹ãƒˆã®è¨­å®šæº–å‚™å®Œäº†" >> $GITHUB_STEP_SUMMARY

  openapi-validation:
    name: OpenAPI Validation Tests
    runs-on: ubuntu-latest
    needs: build-and-test

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run OpenAPI validation tests
        working-directory: ./backend
        run: ./mvnw test -Dtest=OpenApiValidationTest -DskipDockerCompose=true
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
          SPRING_DATASOURCE_USERNAME: testuser
          SPRING_DATASOURCE_PASSWORD: testpass

      - name: Upload OpenAPI validation results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: openapi-validation-results
          path: backend/target/surefire-reports/**/OpenApiValidationTest*.xml

      - name: Generate OpenAPI validation summary
        if: always()
        run: |
          echo "### âœ… OpenAPI ä»•æ§˜æ¤œè¨¼çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "OpenAPI ä»•æ§˜ã¨ã®æ•´åˆæ€§ãŒæ¤œè¨¼ã•ã‚Œã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
