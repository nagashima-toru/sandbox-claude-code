name: Implementation Check

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  check-spec-approved:
    name: Check Spec Approved Label
    runs-on: ubuntu-latest
    # 仕様PRの場合はスキップ
    if: |
      !contains(github.event.pull_request.labels.*.name, 'spec')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR body
        id: pr-body
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            console.log('PR Body:', prBody);

            // PR本文からStory番号を抽出
            const storyMatch = prBody.match(/Story:\s*#(\d+)/i);
            if (!storyMatch) {
              core.setFailed('実装PRにはStory番号が必須です。PR本文に "Story: #xxx" を記載してください。');
              return;
            }

            const storyNumber = storyMatch[1];
            console.log('Parent Story:', storyNumber);
            core.setOutput('story_number', storyNumber);

      - name: Check spec-approved label on parent Story
        if: steps.pr-body.outputs.story_number
        uses: actions/github-script@v7
        with:
          script: |
            const storyNumber = '${{ steps.pr-body.outputs.story_number }}';

            try {
              // 親StoryのIssueを取得
              const { data: story } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(storyNumber)
              });

              console.log('Story labels:', story.labels.map(l => l.name));

              // spec-approved ラベルの確認
              const hasSpecApproved = story.labels.some(label => label.name === 'spec-approved');

              if (!hasSpecApproved) {
                core.setFailed(
                  `親Story #${storyNumber} に 'spec-approved' ラベルが付与されていません。\n` +
                  `実装PRをマージする前に、仕様PRを作成・マージして 'spec-approved' ラベルを取得してください。\n\n` +
                  `**手順:**\n` +
                  `1. 仕様PR（spec.md テンプレート使用）を作成\n` +
                  `2. OpenAPI仕様と受け入れ条件（.feature）を追加\n` +
                  `3. 仕様PRをレビュー・マージ\n` +
                  `4. Story #${storyNumber} に 'spec-approved' ラベルを手動で付与\n` +
                  `5. この実装PRを再実行`
                );
              } else {
                console.log('✅ spec-approved label found on parent Story');
              }
            } catch (error) {
              core.setFailed(`親Story #${storyNumber} の取得に失敗しました: ${error.message}`);
            }

  check-openapi-consistency:
    name: Check OpenAPI Consistency
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.pull_request.labels.*.name, 'spec')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'

      - name: Check OpenAPI consistency (Backend)
        run: |
          if [ -f specs/openapi/openapi.yaml ]; then
            echo "Checking OpenAPI consistency..."
            # TODO: 将来的に swagger-request-validator でテスト実行
            echo "OpenAPI consistency check passed"
          else
            echo "OpenAPI file not found, skipping consistency check"
          fi

  run-acceptance-tests:
    name: Run Acceptance Tests
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.pull_request.labels.*.name, 'spec')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR body
        id: pr-body
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // PR本文から検証した受け入れ条件を抽出
            const criteriaSection = prBody.match(/このPRで検証した受け入れ条件[\s\S]*?##/);
            if (criteriaSection) {
              console.log('Acceptance criteria section found');
              core.setOutput('has_criteria', 'true');
            } else {
              console.log('No acceptance criteria section found');
              core.setOutput('has_criteria', 'false');
            }

      - name: Run acceptance tests
        if: steps.pr-body.outputs.has_criteria == 'true'
        run: |
          echo "Running acceptance tests..."
          # TODO: 将来的に該当する .feature ファイルのテストを実行
          echo "Acceptance tests passed"
