name: Implementation Check

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  check-spec-approved:
    name: Check Spec Approved Label
    runs-on: ubuntu-latest
    # 仕様PRの場合はスキップ
    if: |
      !contains(github.event.pull_request.labels.*.name, 'spec')
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get PR body
        id: pr-body
        uses: actions/github-script@v8
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            console.log('PR Body:', prBody);

            // PR本文からStory番号またはIssue番号を抽出
            // "Story: #xxx" または "Closes #xxx", "Fixes #xxx", "Resolves #xxx" を許容
            const storyMatch = prBody.match(/Story:\s*#(\d+)/i);
            const closesMatch = prBody.match(/(?:Closes|Fixes|Resolves)\s*#(\d+)/i);

            const match = storyMatch || closesMatch;
            if (!match) {
              core.setFailed('実装PRにはStory番号またはIssue番号が必須です。PR本文に "Story: #xxx" または "Closes #xxx" を記載してください。');
              return;
            }

            const issueNumber = match[1];
            console.log('Parent Issue/Story:', issueNumber);
            core.setOutput('story_number', issueNumber);

      - name: Check spec-approved label on parent Story
        if: steps.pr-body.outputs.story_number
        uses: actions/github-script@v8
        with:
          script: |
            const issueNumber = '${{ steps.pr-body.outputs.story_number }}';

            try {
              // 親Issue/Storyを取得
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(issueNumber)
              });

              console.log('Issue labels:', issue.labels.map(l => l.name));

              // spec-approved または ci-cd, security, refactoring ラベルの確認
              const hasSpecApproved = issue.labels.some(label => label.name === 'spec-approved');
              const isCiCd = issue.labels.some(label => label.name === 'ci-cd');
              const isSecurity = issue.labels.some(label => label.name === 'security');
              const isRefactoring = issue.labels.some(label => label.name === 'refactoring');

              // CI/CD、セキュリティ、またはリファクタリング関連のIssueは仕様承認チェックをスキップ
              if (isCiCd || isSecurity || isRefactoring) {
                console.log(`✅ CI/CD、セキュリティ、またはリファクタリング関連Issue #${issueNumber} のため、仕様承認チェックをスキップします`);
                return;
              }

              if (!hasSpecApproved) {
                core.setFailed(
                  `親Story #${issueNumber} に 'spec-approved' ラベルが付与されていません。\n` +
                  `実装PRをマージする前に、仕様PRを作成・マージして 'spec-approved' ラベルを取得してください。\n\n` +
                  `**手順:**\n` +
                  `1. 仕様PR（spec.md テンプレート使用）を作成\n` +
                  `2. OpenAPI仕様と受け入れ条件（.feature）を追加\n` +
                  `3. 仕様PRをレビュー・マージ\n` +
                  `4. Story #${issueNumber} に 'spec-approved' ラベルを手動で付与\n` +
                  `5. この実装PRを再実行\n\n` +
                  `**注意:** CI/CD、セキュリティ、またはリファクタリング関連のIssueの場合は、それぞれ 'ci-cd'、'security'、または 'refactoring' ラベルを付与してください。`
                );
              } else {
                console.log('✅ spec-approved label found on parent Story');
              }
            } catch (error) {
              core.setFailed(`親Issue/Story #${issueNumber} の取得に失敗しました: ${error.message}`);
            }

  check-openapi-consistency:
    name: Check OpenAPI Consistency
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.pull_request.labels.*.name, 'spec')
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'

      - name: Check OpenAPI consistency (Backend)
        run: |
          if [ -f specs/openapi/openapi.yaml ]; then
            echo "Checking OpenAPI consistency..."
            # TODO: 将来的に swagger-request-validator でテスト実行
            echo "OpenAPI consistency check passed"
          else
            echo "OpenAPI file not found, skipping consistency check"
          fi

  run-acceptance-tests:
    name: Run Acceptance Tests
    runs-on: ubuntu-latest
    if: |
      !contains(github.event.pull_request.labels.*.name, 'spec')
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get PR body
        id: pr-body
        uses: actions/github-script@v8
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // PR本文から検証した受け入れ条件を抽出
            const criteriaSection = prBody.match(/このPRで検証した受け入れ条件[\s\S]*?##/);
            if (criteriaSection) {
              console.log('Acceptance criteria section found');
              core.setOutput('has_criteria', 'true');
            } else {
              console.log('No acceptance criteria section found');
              core.setOutput('has_criteria', 'false');
            }

      - name: Run acceptance tests
        if: steps.pr-body.outputs.has_criteria == 'true'
        run: |
          echo "Running acceptance tests..."
          # TODO: 将来的に該当する .feature ファイルのテストを実行
          echo "Acceptance tests passed"
