name: Docker Configuration Tests

on:
  push:
    branches:
      - master
      - main
    paths:
      - '**/Dockerfile'
      - 'docker-compose*.yml'
      - 'nginx.conf'
      - '.github/workflows/docker-test.yml'
  pull_request:
    paths:
      - '**/Dockerfile'
      - 'docker-compose*.yml'
      - 'nginx.conf'
      - '.github/workflows/docker-test.yml'

jobs:
  development-build:
    name: Test Development Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend (development)
        run: docker compose build frontend

      - name: Build backend (development)
        run: docker compose build backend

      - name: Verify development images exist
        run: |
          docker images | grep sandbox-claude-code-frontend
          docker images | grep sandbox-claude-code-backend

  production-build:
    name: Test Production Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend (production)
        run: docker compose -f docker-compose.yml build frontend

      - name: Build backend (production)
        run: docker compose -f docker-compose.yml build backend

      - name: Verify production images exist
        run: |
          docker images | grep sandbox-claude-code-frontend
          docker images | grep sandbox-claude-code-backend

  development-startup:
    name: Test Development Startup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start containers (development)
        run: docker compose up -d

      - name: Wait for containers to start
        run: sleep 15

      - name: Check containers are running
        run: |
          docker compose ps
          docker compose ps | grep "Up" | grep frontend
          docker compose ps | grep "Up" | grep backend

      - name: Check container logs for errors
        if: always()
        run: |
          echo "=== Frontend Logs ==="
          docker compose logs frontend | tail -n 50
          echo "=== Backend Logs ==="
          docker compose logs backend | tail -n 50

      - name: Stop containers
        if: always()
        run: docker compose down -v

  production-startup:
    name: Test Production Startup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start containers (production)
        run: docker compose -f docker-compose.yml up -d

      - name: Wait for containers to start
        run: sleep 15

      - name: Check containers are running
        run: |
          docker compose -f docker-compose.yml ps
          docker compose -f docker-compose.yml ps | grep "Up" | grep frontend
          docker compose -f docker-compose.yml ps | grep "Up" | grep backend
          docker compose -f docker-compose.yml ps | grep "Up" | grep nginx

      - name: Check container logs for errors
        if: always()
        run: |
          echo "=== Frontend Logs ==="
          docker compose -f docker-compose.yml logs frontend | tail -n 50
          echo "=== Backend Logs ==="
          docker compose -f docker-compose.yml logs backend | tail -n 50
          echo "=== Nginx Logs ==="
          docker compose -f docker-compose.yml logs nginx | tail -n 50

      - name: Stop containers
        if: always()
        run: docker compose -f docker-compose.yml down -v

  development-health-checks:
    name: Test Development Health Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start containers (development)
        run: docker compose up -d

      - name: Wait for services to be ready
        run: sleep 20

      - name: Test frontend is accessible
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'
          echo "âœ… Frontend is accessible at http://localhost:3000"

      - name: Test backend health endpoint
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 2; done'
          echo "âœ… Backend health check passed"

      - name: Test backend API endpoint
        run: |
          # Test that API is responding (200 or 404 is acceptable - means backend is running)
          curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/messages | grep -E "^(200|404)$"
          echo "âœ… Backend API is responding"

      - name: Verify backend health response
        run: |
          response=$(curl -s http://localhost:8080/actuator/health)
          echo "Health response: $response"
          echo "$response" | grep -q '"status":"UP"'
          echo "âœ… Backend health status is UP"

      - name: Stop containers
        if: always()
        run: docker compose down -v

  production-health-checks:
    name: Test Production Health Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start containers (production)
        run: docker compose -f docker-compose.yml up -d

      - name: Wait for services to be ready
        run: sleep 30

      - name: Test nginx is accessible
        run: |
          timeout 60 bash -c 'until curl -f http://localhost; do sleep 2; done'
          echo "âœ… Nginx is accessible at http://localhost"

      - name: Test frontend through nginx
        run: |
          curl -f http://localhost
          echo "âœ… Frontend is accessible through nginx"

      - name: Test backend API through nginx
        run: |
          # Test that API is responding through nginx (200 or 404 is acceptable)
          curl -s -o /dev/null -w "%{http_code}" http://localhost/api/messages | grep -E "^(200|404)$"
          echo "âœ… Backend API is accessible through nginx"

      - name: Test backend health through nginx
        run: |
          timeout 60 bash -c 'until curl -f http://localhost/actuator/health; do sleep 2; done'
          response=$(curl -s http://localhost/actuator/health)
          echo "Health response: $response"
          echo "$response" | grep -q '"status":"UP"'
          echo "âœ… Backend health check through nginx passed"

      - name: Stop containers
        if: always()
        run: docker compose -f docker-compose.yml down -v

  production-permissions:
    name: Test Production Container Permissions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start frontend (production)
        run: docker compose -f docker-compose.yml up -d frontend

      - name: Wait for frontend to start
        run: sleep 10

      - name: Verify frontend runs as non-root user
        run: |
          user=$(docker exec sandbox-frontend whoami)
          echo "Frontend running as user: $user"
          if [ "$user" = "nextjs" ]; then
            echo "âœ… Frontend is running as non-root user 'nextjs'"
          else
            echo "âŒ Frontend should run as 'nextjs' but is running as '$user'"
            exit 1
          fi

      - name: Verify frontend has write permissions in /app
        run: |
          docker exec sandbox-frontend touch /app/.next/test-write.txt
          docker exec sandbox-frontend rm /app/.next/test-write.txt
          echo "âœ… Frontend has correct write permissions"

      - name: Verify frontend directory ownership
        run: |
          owner=$(docker exec sandbox-frontend stat -c '%U' /app)
          echo "Directory /app owned by: $owner"
          if [ "$owner" = "nextjs" ]; then
            echo "âœ… Directory ownership is correct"
          else
            echo "âŒ Directory should be owned by 'nextjs' but is owned by '$owner'"
            exit 1
          fi

      - name: Stop containers
        if: always()
        run: docker compose -f docker-compose.yml down -v

  integration-test:
    name: Test Frontend-Backend Integration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start all services (development)
        run: docker compose up -d

      - name: Wait for all services to be ready
        run: sleep 20

      - name: Test backend is accessible
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 2; done'
          echo "âœ… Backend is ready"

      - name: Test frontend is accessible
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'
          echo "âœ… Frontend is ready"

      - name: Test API call from host
        run: |
          # Test that API is responding (200 or 404 is acceptable)
          http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/messages)
          echo "API Response Code: $http_code"
          echo "$http_code" | grep -E "^(200|404)$"
          echo "âœ… API endpoint is responding"

      - name: Test frontend can reach backend
        run: |
          # Frontend should be configured to call backend at http://localhost:8080
          # This verifies the NEXT_PUBLIC_API_URL configuration
          http_code=$(docker exec sandbox-frontend sh -c 'curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/messages')
          echo "API Response Code from frontend: $http_code"
          echo "$http_code" | grep -E "^(200|404)$"
          echo "âœ… Frontend container can reach backend"

      - name: Show container network information
        run: |
          echo "=== Container Network Info ==="
          docker network ls
          docker network inspect sandbox-claude-code_default || true

      - name: Stop containers
        if: always()
        run: docker compose down -v

  production-integration-test:
    name: Test Production Integration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start all services (production)
        run: docker compose -f docker-compose.yml up -d

      - name: Wait for all services to be ready
        run: sleep 30

      - name: Test all services through nginx
        run: |
          # Frontend
          curl -f http://localhost
          echo "âœ… Frontend accessible through nginx"

          # Backend API
          http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/messages)
          echo "API Response Code: $http_code"
          echo "$http_code" | grep -E "^(200|404)$"
          echo "âœ… Backend API accessible through nginx"

          # Health check
          curl -f http://localhost/actuator/health
          echo "âœ… Health check accessible through nginx"

      - name: Test nginx routing configuration
        run: |
          # Verify nginx routes /api to backend
          http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/messages)
          echo "API response code through nginx: $http_code"
          echo "$http_code" | grep -E "^(200|404)$"

          # Verify nginx routes / to frontend
          frontend_response=$(curl -s http://localhost)
          echo "Frontend response length: ${#frontend_response}"
          [ ${#frontend_response} -gt 100 ] # Frontend HTML should be substantial
          echo "âœ… Nginx routing is working correctly"

      - name: Verify API is accessible through nginx
        run: |
          # Test API headers when accessing through nginx
          curl -I http://localhost/api/messages
          echo "âœ… API headers checked through nginx"

      - name: Stop containers
        if: always()
        run: docker compose -f docker-compose.yml down -v

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - development-build
      - production-build
      - development-startup
      - production-startup
      - development-health-checks
      - production-health-checks
      - production-permissions
      - integration-test
      - production-integration-test
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ³ Docker Configuration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Development mode build" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production mode build" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Development mode startup" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production mode startup" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Development health checks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production health checks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production container permissions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend-backend integration (development)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend-backend integration (production)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configurations Tested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Development mode: \`docker compose up\`" >> $GITHUB_STEP_SUMMARY
          echo "- Production mode: \`docker compose -f docker-compose.yml up\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Docker configurations have been validated! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
