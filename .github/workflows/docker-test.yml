name: Docker Configuration Tests

on:
  push:
    branches:
      - master
      - main
    paths:
      - '**/Dockerfile'
      - 'docker-compose*.yml'
      - 'nginx.conf'
      - '.github/workflows/docker-test.yml'
  pull_request:
    paths:
      - '**/Dockerfile'
      - 'docker-compose*.yml'
      - 'nginx.conf'
      - '.github/workflows/docker-test.yml'

jobs:
  build-tests:
    name: Test ${{ matrix.mode }} Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mode: [development, production]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers (frontend)
        uses: actions/cache@v5
        with:
          path: /tmp/.buildx-cache-frontend
          key: ${{ runner.os }}-buildx-frontend-${{ matrix.mode }}-${{ hashFiles('frontend/Dockerfile', 'frontend/package.json', 'frontend/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-buildx-frontend-${{ matrix.mode }}-

      - name: Cache Docker layers (backend)
        uses: actions/cache@v5
        with:
          path: /tmp/.buildx-cache-backend
          key: ${{ runner.os }}-buildx-backend-${{ matrix.mode }}-${{ hashFiles('backend/Dockerfile', 'backend/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-buildx-backend-${{ matrix.mode }}-

      - name: Build frontend (${{ matrix.mode }})
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            docker compose -f docker-compose.yml build frontend
          else
            docker compose build frontend
          fi

      - name: Build backend (${{ matrix.mode }})
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            docker compose -f docker-compose.yml build backend
          else
            docker compose build backend
          fi

      - name: Verify images exist
        run: |
          docker images | grep sandbox-claude-code-frontend
          docker images | grep sandbox-claude-code-backend

  startup-tests:
    name: Test ${{ matrix.mode }} Startup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mode: [development, production]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start containers (${{ matrix.mode }})
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            docker compose -f docker-compose.yml up -d
          else
            docker compose up -d
          fi

      - name: Wait for containers to start
        run: sleep 15

      - name: Check containers are running
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            docker compose -f docker-compose.yml ps
            docker compose -f docker-compose.yml ps | grep "Up" | grep frontend
            docker compose -f docker-compose.yml ps | grep "Up" | grep backend
            docker compose -f docker-compose.yml ps | grep "Up" | grep nginx
          else
            docker compose ps
            docker compose ps | grep "Up" | grep frontend
            docker compose ps | grep "Up" | grep backend
          fi

      - name: Check container logs for errors
        if: always()
        run: |
          echo "=== Frontend Logs ==="
          if [ "${{ matrix.mode }}" = "production" ]; then
            docker compose -f docker-compose.yml logs frontend | tail -n 50
          else
            docker compose logs frontend | tail -n 50
          fi
          echo "=== Backend Logs ==="
          if [ "${{ matrix.mode }}" = "production" ]; then
            docker compose -f docker-compose.yml logs backend | tail -n 50
          else
            docker compose logs backend | tail -n 50
          fi
          if [ "${{ matrix.mode }}" = "production" ]; then
            echo "=== Nginx Logs ==="
            docker compose -f docker-compose.yml logs nginx | tail -n 50
          fi

      - name: Stop containers
        if: always()
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            docker compose -f docker-compose.yml down -v
          else
            docker compose down -v
          fi

  health-check-tests:
    name: Test ${{ matrix.mode }} Health Checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mode: [development, production]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start containers (${{ matrix.mode }})
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            docker compose -f docker-compose.yml up -d
          else
            docker compose up -d
          fi

      - name: Wait for services to be ready
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            sleep 30
          else
            sleep 20
          fi

      - name: Test services accessibility
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            # Production: Test through nginx
            timeout 60 bash -c 'until curl -f http://localhost; do sleep 2; done'
            echo "âœ… Nginx is accessible at http://localhost"

            curl -f http://localhost
            echo "âœ… Frontend is accessible through nginx"

            http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/messages)
            echo "API Response Code: $http_code"
            echo "$http_code" | grep -E "^(200|404)$"
            echo "âœ… Backend API accessible through nginx"

            timeout 60 bash -c 'until curl -f http://localhost/actuator/health; do sleep 2; done'
            response=$(curl -s http://localhost/actuator/health)
            echo "Health response: $response"
            echo "$response" | grep -q '"status":"UP"'
            echo "âœ… Backend health check through nginx passed"
          else
            # Development: Test direct access
            timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'
            echo "âœ… Frontend is accessible at http://localhost:3000"

            timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 2; done'
            echo "âœ… Backend health check passed"

            curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/messages | grep -E "^(200|404)$"
            echo "âœ… Backend API is responding"

            response=$(curl -s http://localhost:8080/actuator/health)
            echo "Health response: $response"
            echo "$response" | grep -q '"status":"UP"'
            echo "âœ… Backend health status is UP"
          fi

      - name: Stop containers
        if: always()
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            docker compose -f docker-compose.yml down -v
          else
            docker compose down -v
          fi

  production-permissions:
    name: Test Production Container Permissions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start frontend (production)
        run: docker compose -f docker-compose.yml up -d frontend

      - name: Wait for frontend to start
        run: sleep 10

      - name: Verify frontend runs as non-root user
        run: |
          FRONTEND_CONTAINER=$(docker compose -f docker-compose.yml ps -q frontend)
          user=$(docker exec $FRONTEND_CONTAINER whoami)
          echo "Frontend running as user: $user"
          if [ "$user" = "nextjs" ]; then
            echo "âœ… Frontend is running as non-root user 'nextjs'"
          else
            echo "âŒ Frontend should run as 'nextjs' but is running as '$user'"
            exit 1
          fi

      - name: Verify frontend has write permissions in /app
        run: |
          FRONTEND_CONTAINER=$(docker compose -f docker-compose.yml ps -q frontend)
          docker exec $FRONTEND_CONTAINER touch /app/.next/test-write.txt
          docker exec $FRONTEND_CONTAINER rm /app/.next/test-write.txt
          echo "âœ… Frontend has correct write permissions"

      - name: Verify frontend directory ownership
        run: |
          FRONTEND_CONTAINER=$(docker compose -f docker-compose.yml ps -q frontend)
          owner=$(docker exec $FRONTEND_CONTAINER stat -c '%U' /app)
          echo "Directory /app owned by: $owner"
          if [ "$owner" = "nextjs" ]; then
            echo "âœ… Directory ownership is correct"
          else
            echo "âŒ Directory should be owned by 'nextjs' but is owned by '$owner'"
            exit 1
          fi

      - name: Stop containers
        if: always()
        run: docker compose -f docker-compose.yml down -v

  integration-tests:
    name: Test ${{ matrix.mode }} Integration
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mode: [development, production]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start all services (${{ matrix.mode }})
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            docker compose -f docker-compose.yml up -d
          else
            docker compose up -d
          fi

      - name: Wait for all services to be ready
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            sleep 30
          else
            sleep 20
          fi

      - name: Test integration
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            # Production: Test all services through nginx
            curl -f http://localhost
            echo "âœ… Frontend accessible through nginx"

            http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/messages)
            echo "API Response Code: $http_code"
            echo "$http_code" | grep -E "^(200|404)$"
            echo "âœ… Backend API accessible through nginx"

            curl -f http://localhost/actuator/health
            echo "âœ… Health check accessible through nginx"

            # Verify nginx routing configuration
            http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/messages)
            echo "API response code through nginx: $http_code"
            echo "$http_code" | grep -E "^(200|404)$"

            frontend_response=$(curl -s http://localhost)
            echo "Frontend response length: ${#frontend_response}"
            [ ${#frontend_response} -gt 100 ]
            echo "âœ… Nginx routing is working correctly"

            curl -I http://localhost/api/messages
            echo "âœ… API headers checked through nginx"
          else
            # Development: Test backend and frontend
            timeout 60 bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 2; done'
            echo "âœ… Backend is ready"

            timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'
            echo "âœ… Frontend is ready"

            http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/messages)
            echo "API Response Code: $http_code"
            echo "$http_code" | grep -E "^(200|404)$"
            echo "âœ… API endpoint is responding"

            echo "=== Container Network Info ==="
            docker network ls
            docker network inspect sandbox-claude-code_default || true
          fi

      - name: Stop containers
        if: always()
        run: |
          if [ "${{ matrix.mode }}" = "production" ]; then
            docker compose -f docker-compose.yml down -v
          else
            docker compose down -v
          fi

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - build-tests
      - startup-tests
      - health-check-tests
      - production-permissions
      - integration-tests
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ³ Docker Configuration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Development mode build" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production mode build" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Development mode startup" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production mode startup" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Development health checks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production health checks" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Production container permissions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend-backend integration (development)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend-backend integration (production)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configurations Tested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Development mode: \`docker compose up\`" >> $GITHUB_STEP_SUMMARY
          echo "- Production mode: \`docker compose -f docker-compose.yml up\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Docker configurations have been validated! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
